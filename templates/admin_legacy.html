<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</title>
  <style>
    body { font-family: Arial, sans-serif; }
    section { margin-bottom: 20px; padding: 10px; border: 1px solid #ddd; }
    .section-title { font-weight: bold; margin-bottom: 5px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px 12px; border: 1px solid #ddd; text-align: center; }
    textarea { width: 100%; height: 100px; padding: 10px; border: 1px solid #ddd; }
    .comment-box { margin-top: 10px; }
    .comment-box textarea { width: 100%; height: 50px; }
    .comment-item { border-left: 3px solid #ddd; padding-left: 10px; margin-top: 5px; font-size: 14px; }
  </style>
</head>
<body>
  <h1>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>

  <!-- ì—…ë¬´ í˜„í™© í…Œì´ë¸” -->
  <section id="task-status-section">
    <div class="section-title">ì—…ë¬´ í˜„í™©</div>
    <table>
      <thead>
        <tr>
          <th>ê³¼ì •</th>
          <th>ì—…ë¬´ ì™„ë£Œìœ¨</th>
          <th>ê¸´ê¸‰ì—…ë¬´</th>
          <th>ìƒíƒœ</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>ë°ì´í„° ë¶„ì„ ìŠ¤ì¿¨</td>
          <td>80%</td>
          <td>ê¸´ê¸‰</td>
          <td>ì§„í–‰ ì¤‘</td>
        </tr>
        <tr>
          <td>í´ë¼ìš°ë“œ ìŠ¤ì¿¨</td>
          <td>60%</td>
          <td>ì¼ë°˜</td>
          <td>ëŒ€ê¸° ì¤‘</td>
        </tr>
        <tr>
          <td>ê²Œì„ ìŠ¤ì¿¨</td>
          <td>50%</td>
          <td>ê¸´ê¸‰</td>
          <td>ì§„í–‰ ì¤‘</td>
        </tr>
      </tbody>
    </table>
  </section>

  <!-- ì „ë‹¬ì‚¬í•­ í…ìŠ¤íŠ¸ ì…ë ¥ë€ -->
  <section id="remarks-section">
    <div class="section-title">ì „ë‹¬ì‚¬í•­</div>
    <textarea id="remarks" placeholder="ì—¬ê¸°ì— ì „ë‹¬ì‚¬í•­ì„ ì ì–´ì£¼ì„¸ìš”."></textarea>
    <button onclick="saveRemarks()">ì €ì¥</button>
  </section>

  <!-- ì´ìŠˆì‚¬í•­ í‘œì‹œ ì„¹ì…˜ -->
  <section id="issue-display-section">
    <div class="section-title">ì´ìŠˆì‚¬í•­ ëª©ë¡</div>
    <div id="issue-list"></div>
  </section>

  <!-- ë¹„ì •ê¸° ì—…ë¬´ ì²´í¬ë¦¬ìŠ¤íŠ¸ í‘œì‹œ ì„¹ì…˜ -->
  <section id="admin-irregular-tasks-section">
    <div class="section-title">ë¹„ì •ê¸° ì—…ë¬´ ì²´í¬ë¦¬ìŠ¤íŠ¸ (ê´€ë¦¬ì)</div>
    <div id="admin-irregular-task-list"></div>
  </section>

  <!-- ë¯¸ì²´í¬ í•­ëª© ì„¤ëª… í‘œì‹œ ì„¹ì…˜ -->
  <section id="unchecked-description-display-section">
    <div class="section-title">ë¯¸ì²´í¬ í•­ëª© ì„¤ëª…</div>
    <div id="unchecked-descriptions"></div>
  </section>

  <script>
    async function saveRemarks() {
      const remarks = document.getElementById('remarks').value;

      if (!remarks) {
        alert("ì „ë‹¬ì‚¬í•­ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }

      try {
        const response = await fetch('/remarks', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ remarks })  
        });
        
        const result = await response.json();
        if (response.ok && result.success) {
          alert('ì „ë‹¬ì‚¬í•­ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
        } else {
          alert('ì „ë‹¬ì‚¬í•­ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (error) {
        console.error("Error saving remarks:", error);
        alert('ì„œë²„ì— ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }

    async function fetchIssues() {
    try {
        console.log("ğŸ“Œ /issues API í˜¸ì¶œ ì‹œì‘"); // âœ… ìš”ì²­ ì‹œì‘ ë¡œê·¸ ì¶”ê°€
        const response = await fetch('/issues');

        if (!response.ok) throw new Error(`âŒ HTTP ì˜¤ë¥˜! ìƒíƒœ ì½”ë“œ: ${response.status}`);

        const result = await response.json();
        console.log("âœ… /issues API ì‘ë‹µ ë°ì´í„°:", result); // âœ… API ì‘ë‹µ ë°ì´í„° í™•ì¸

        if (result.success && result.data.length > 0) {
            const issueListDiv = document.getElementById('issue-list');
            issueListDiv.innerHTML = "";

            result.data.forEach(issue => {
                const issueItem = document.createElement('div');
                issueItem.innerHTML = `
                    <p><strong>ì´ìŠˆ:</strong> ${issue.content}</p>
                    <small>ì‘ì„±ì¼: ${new Date(issue.created_at).toLocaleString()}</small>
                    <button onclick="resolveIssue(${issue.id})">í•´ê²°</button>
                    <div id="comments-${issue.id}" class="comments-section"></div>
                    <div class="comment-box">
                        <textarea id="comment-text-${issue.id}" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                        <button onclick="addComment(${issue.id})">ëŒ“ê¸€ ì¶”ê°€</button>
                    </div>
                    <hr>
                `;
                issueListDiv.appendChild(issueItem);
                fetchComments(issue.id);
            });

            fetchAdminIrregularTasks();
        } else {
            console.warn("âš ï¸ í˜„ì¬ ë“±ë¡ëœ ì´ìŠˆê°€ ì—†ìŠµë‹ˆë‹¤.");
            document.getElementById('issue-list').innerText = "í˜„ì¬ ë“±ë¡ëœ ì´ìŠˆê°€ ì—†ìŠµë‹ˆë‹¤.";
        }
    } catch (error) {
        console.error("âŒ ì´ìŠˆ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", error);
        document.getElementById('issue-list').innerText = "ì´ìŠˆë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ!";
    }
}
    async function fetchUncheckedDescriptions() {
      try {
        const response = await fetch('/unchecked_descriptions');
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);

        const result = await response.json();
        console.log("ë¯¸ì²´í¬ í•­ëª© ì‘ë‹µ:", result); // ë””ë²„ê¹…ìš© ë¡œê·¸

        if (result.success && result.data.length > 0) {
          const descriptionsDiv = document.getElementById('unchecked-descriptions');
          descriptionsDiv.innerHTML = "";

          result.data.forEach((desc, index) => {
            const descItem = document.createElement('div');
            descItem.innerHTML = `<p><strong>${index + 1}. </strong>${desc}</p>`;
            descriptionsDiv.appendChild(descItem);
          });
        } else {
          document.getElementById('unchecked-descriptions').innerText = "ë¯¸ì²´í¬ í•­ëª© ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.";
        }
      } catch (error) {
        console.error("ë¯¸ì²´í¬ í•­ëª© ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", error);
        document.getElementById('unchecked-descriptions').innerText = "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
      }
    }

    // ì´ˆê¸° ë°ì´í„° ë¡œë”©
    fetchIssues();
    fetchUncheckedDescriptions();
  </script>
</body>
</html>
